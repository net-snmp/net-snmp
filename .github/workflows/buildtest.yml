name: Build and test

on: [workflow_dispatch]
#on:
#  push:
#    branches: [ master ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: install required packages
      run: sudo apt-get install libatm-dev libperl-dev libpopt-dev libsensors4-dev libssh2-1-dev libxml2-dev uuid-dev libkrb5-dev python3-setuptools

    - name: configure
      run: ./configure --enable-developer --enable-ipv6 --prefix=/usr/local/net-snmp-master --with-cflags= --with-defaults --enable-new-features --with-perl-modules --with-default-snmp-version=2 --with-systemd --enable-blumenthal-aes --with-python-modules '--with-transports=AAL5PVC IPX STD UDPshared DTLSUDP TLSTCP' '--with-security-modules=usm tsm ksm' '--with-mib-modules=examples/data_set examples/delayed_instance examples/example examples/notification examples/scalar_int examples/ucdDemoPublic examples/watched smux deliver/deliverByNotify disman/event disman/mteEventNotificationTable disman/mteEventTable disman/mteObjectsTable disman/mteTriggerBooleanTable disman/mteTriggerDeltaTable disman/mteTriggerExistenceTable disman/mteTriggerTable disman/mteTriggerThresholdTable disman/nslookup-mib disman/ping-mib disman/schedule disman/traceroute-mib etherlike-mib examples/netSnmpHostsTable hardware/cpu hardware/fsys hardware/memory host ip-forward-mib ip-mib/inetNetToMediaTable ip-mib/ipDefaultRouterTable ip-mib/ipv4InterfaceTable ip-mib/ipv6InterfaceTable ip-mib/ipv6ScopeZoneIndexTable mibII/ipAddr mibII/mta_sendmail misc/ipfwacc sctp-mib snmp-notification-mib tcp-mib testhandler tunnel ucd-snmp/diskio hardware/sensors ucd-snmp/lmsensorsMib ucd-snmp/extensible udp-mib rmon-mib snmp-usm-dh-objects-mib tlstm-mib tsm-mib'

    - name: build
      run: make

    - name: test default
      run: cd testing; ./RUNFULLTESTS -g default

    - name: test perl
      run: cd testing; ./RUNFULLTESTS -g perl

    - name: test read-only
      continue-on-error: true
      run: cd testing; ./RUNFULLTESTS -g read-only

    - name: test snmv3
      run: cd testing; ./RUNFULLTESTS -g snmpv3

    - name: test tls
      continue-on-error: true
      run: cd testing; ./RUNFULLTESTS -g tls

    - name: test transports
      run: cd testing; ./RUNFULLTESTS -g transports

    - name: test unit-tests
      run: cd testing; ./RUNFULLTESTS -g unit-tests
