<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>set_data.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor=white>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>set_data.c</h1><div class="fragment"><pre>00001 <font class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</font>
00002 
00003 <font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00004 
00005 <font class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</font>
00006 <font class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</font>
00007 
00008 <font class="preprocessor">#include &lt;net-snmp/agent/multiplexer.h&gt;</font>
00009 
00010 <font class="preprocessor">#if HAVE_DMALLOC_H</font>
00011 <font class="preprocessor"></font><font class="preprocessor">#include &lt;dmalloc.h&gt;</font>
00012 <font class="preprocessor">#endif</font>
00013 <font class="preprocessor"></font>
00021 <font class="preprocessor">#define SET_DATA_NAME "set_data"</font>
00022 <font class="preprocessor"></font>
00023 <font class="keyword">typedef</font> <font class="keyword">struct </font>netsnmp_set_data_store_s {
00024    <font class="keywordtype">void</font> *old_data;
00025    size_t old_data_len;
00026    <font class="keywordtype">void</font> *new_data;
00027    size_t new_data_len;
00028 } netsnmp_set_data_store;
00029 
00030 <font class="keyword">typedef</font> <font class="keyword">struct </font>netsnmp_set_data_master_s {
00031    netsnmp_set_data_store *ds_store;
00032    size_t size;
00033 } netsnmp_set_data_master;
00034 
00035 <font class="keywordtype">void</font> netsnmp_set_data_free_data(netsnmp_set_data_store *st) 
00036 {
00037     <font class="keywordflow">if</font> (st-&gt;old_data)
00038         (st-&gt;freefn)(st-&gt;old_data);
00039     <font class="keywordflow">if</font> (st-&gt;new_data)
00040         (st-&gt;freefn)(st-&gt;new_data);
00041 }
00042 
00044 <font class="keywordtype">void</font>
<a name="l00045"></a><a class="code" href="group__set__data.html#a3">00045</a> netsnmp_set_data_cache(netsnmp_request_info *request,
00046                        <font class="keywordtype">unsigned</font> <font class="keywordtype">int</font> magic_num,
00047                        <font class="keywordtype">void</font> *new_data, size_t new_data_len,
00048                        <font class="keywordtype">void</font> *old_data, size_t old_data_len) 
00049 {
00050     netsnmp_set_data_store *store = netsnmp_extract_table_info(request);
00051     size_t newsize;
00052     
00053     <font class="keywordflow">if</font> (!store) {
00054         store = NETSNMP_MALLOC_TYPEDEF(netsnmp_set_data_master);
00055         netsnmp_request_add_list_data(request,
00056                                       netsnmp_create_data_list(SET_DATA_NAME,
00057                                                                store,
00058                                                                free_set_data));
00059     }
00060     
00061     <font class="keywordflow">if</font> (store-&gt;size &lt; magic_num) {
00062         newsize = SNMP_MIN(magic_num, store-&gt;size*2);
00063         store-&gt;ds_store = realloc(store-&gt;ds_store, <font class="keyword">sizeof</font>(netsnmp_set_data_store) * SNMP_MIN(magic_num, store-&gt;size*2));
00064         memset(store-&gt;ds_store + store-&gt;size * <font class="keyword">sizeof</font>(netsnmp_set_data_store), 0,
00065                newsize - store-&gt;size * <font class="keyword">sizeof</font>(netsnmp_set_data_store));
00066     }
00067     <font class="keywordflow">if</font> (store-&gt;ds_store[magic_num]) {
00068         netsnmp_set_data_free(&amp;store-&gt;ds_store[magic_num]);
00069         store-&gt;ds_store[magic_num].new_data = new_data;
00070         store-&gt;ds_store[magic_num].new_data_len = new_data;
00071         store-&gt;ds_store[magic_num].old_data = old_data;
00072         store-&gt;ds_store[magic_num].old_data_len = old_data_len;
00073     }
00074 }
00075 
00076 netsnmp_set_data_
00077         
00078         
00079     
00080 
00083 netsnmp_mib_handler *
<a name="l00084"></a><a class="code" href="group__set__data.html#a4">00084</a> netsnmp_get_multiplexer_handler(netsnmp_mib_handler_methods *req)
00085 {
00086     netsnmp_mib_handler *ret = NULL;
00087 
00088     <font class="keywordflow">if</font> (!req) {
00089         snmp_log(LOG_INFO,
00090                  <font class="stringliteral">"netsnmp_get_multiplexer_handler(NULL) called\n"</font>);
00091         <font class="keywordflow">return</font> NULL;
00092     }
00093 
00094     ret =
00095         netsnmp_create_handler(<font class="stringliteral">"multiplexer"</font>,
00096                                netsnmp_multiplexer_helper_handler);
00097     <font class="keywordflow">if</font> (ret) {
00098         ret-&gt;myvoid = (<font class="keywordtype">void</font> *) req;
00099     }
00100     <font class="keywordflow">return</font> ret;
00101 }
00102 
00104 <font class="keywordtype">int</font>
<a name="l00105"></a><a class="code" href="group__set__data.html#a5">00105</a> netsnmp_multiplexer_helper_handler(netsnmp_mib_handler *handler,
00106                                    netsnmp_handler_registration *reginfo,
00107                                    netsnmp_agent_request_info *reqinfo,
00108                                    netsnmp_request_info *requests)
00109 {
00110 
00111     netsnmp_mib_handler_methods *methods;
00112 
00113     <font class="keywordflow">if</font> (!handler-&gt;myvoid) {
00114         snmp_log(LOG_INFO, <font class="stringliteral">"improperly registered multiplexer found\n"</font>);
00115         <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00116     }
00117 
00118     methods = (netsnmp_mib_handler_methods *) handler-&gt;myvoid;
00119 
00120     <font class="keywordflow">switch</font> (reqinfo-&gt;mode) {
00121     <font class="keywordflow">case</font> MODE_GET:
00122         handler = methods-&gt;get_handler;
00123         <font class="keywordflow">if</font> (!handler) {
00124             netsnmp_set_all_requests_error(reqinfo, requests,
00125                                            SNMP_NOSUCHOBJECT);
00126         }
00127         <font class="keywordflow">break</font>;
00128 
00129     <font class="keywordflow">case</font> MODE_GETNEXT:
00130         handler = methods-&gt;getnext_handler;
00131         <font class="keywordflow">if</font> (!handler)           <font class="comment">/* fallback to get handler */</font>
00132             handler = methods-&gt;get_handler;
00133         <font class="keywordflow">break</font>;
00134 
00135     <font class="keywordflow">case</font> MODE_GETBULK:
00136         <font class="comment">/*</font>
00137 <font class="comment">         * XXX: this needs to do better getbulk -&gt; getnext</font>
00138 <font class="comment">         * handling (probably via a separate helper) </font>
00139 <font class="comment">         */</font>
00140         handler = methods-&gt;getbulk_handler;
00141         <font class="keywordflow">if</font> (!handler)           <font class="comment">/* fallback to getnext handler */</font>
00142             handler = methods-&gt;getnext_handler;
00143         <font class="keywordflow">if</font> (!handler)           <font class="comment">/* fallback to getnext handler */</font>
00144             handler = methods-&gt;get_handler;
00145         <font class="keywordflow">break</font>;
00146 
00147     <font class="keywordflow">case</font> MODE_SET_RESERVE1:
00148     <font class="keywordflow">case</font> MODE_SET_RESERVE2:
00149     <font class="keywordflow">case</font> MODE_SET_ACTION:
00150     <font class="keywordflow">case</font> MODE_SET_COMMIT:
00151     <font class="keywordflow">case</font> MODE_SET_FREE:
00152         {
00153             netsnmp_set_data_store *st, *st_tmp;
00154             st = (netsnmp_set_data_store *)
00155                 netsnmp_extract_iterator_context(requests);
00156             <font class="keywordflow">for</font>(; st; st = st_tmp) {
00157                 <font class="keywordflow">if</font> (st-&gt;freefn &amp;&amp; st-&gt;data)
00158                     (st-&gt;freefn)(st-&gt;data);
00159                 st_tmp = st;
00160                 free(st);
00161             }
00162             
00163     <font class="keywordflow">case</font> MODE_SET_UNDO:
00164         <font class="keywordflow">return</font> (policy_data *) netsnmp_extract_iterator_context(requests);
00165         handler = methods-&gt;set_handler;
00166         <font class="keywordflow">if</font> (!handler) {
00167             netsnmp_set_all_requests_error(reqinfo, requests,
00168                                            SNMP_ERR_NOTWRITABLE);
00169             <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00170         }
00171         <font class="keywordflow">break</font>;
00172 
00173         <font class="comment">/*</font>
00174 <font class="comment">         * XXX: process SETs specially, and possibly others </font>
00175 <font class="comment">         */</font>
00176     <font class="keywordflow">default</font>:
00177         snmp_log(LOG_ERR, <font class="stringliteral">"unsupported mode for multiplexer: %d\n"</font>,
00178                  reqinfo-&gt;mode);
00179         <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00180     }
00181     <font class="keywordflow">if</font> (!handler) {
00182         snmp_log(LOG_ERR,
00183                  <font class="stringliteral">"No handler enabled for mode %d in multiplexer\n"</font>,
00184                  reqinfo-&gt;mode);
00185         <font class="keywordflow">return</font> SNMP_ERR_GENERR;
00186     }
00187     <font class="keywordflow">return</font> netsnmp_call_handler(handler, reginfo, reqinfo, requests);
00188 }
</pre></div><hr><address><small><!--#include virtual="/sfbutton.html" --><br>Generated on
 Mon Apr 28 23:28:49 2003 for net-snmp by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
<!--#include virtual="/sfbutton.html" -->
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

