<!--#set var="section" value="development" -->
<!--#include virtual="/page-top.html" -->
<!-- CONTENT START -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>system_mib.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor=white bgcolor="#ffffff">
<!-- Generated by Doxygen 1.2.11 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>system_mib.c</h1><div class="fragment"><pre>00001 <font class="comment">/*</font>
00002  *  System MIB group implementation - system.c
00003  *
00004  */
00005 
00006 <font class="preprocessor">#include &lt;net-snmp/net-snmp-config.h&gt;</font>
00007 
00008 <font class="preprocessor">#if HAVE_STDLIB_H</font>
00009 <font class="preprocessor">#include &lt;stdlib.h&gt;</font>
00010 <font class="preprocessor">#endif</font>
00011 <font class="preprocessor">#ifdef HAVE_UNISTD_H</font>
00012 <font class="preprocessor">#include &lt;unistd.h&gt;</font>
00013 <font class="preprocessor">#endif</font>
00014 <font class="preprocessor">#if HAVE_STRING_H</font>
00015 <font class="preprocessor">#include &lt;string.h&gt;</font>
00016 <font class="preprocessor">#else</font>
00017 <font class="preprocessor">#include &lt;strings.h&gt;</font>
00018 <font class="preprocessor">#endif</font>
00019 <font class="preprocessor">#include &lt;sys/types.h&gt;</font>
00020 <font class="preprocessor">#if HAVE_WINSOCK_H</font>
00021 <font class="preprocessor">#include &lt;winsock.h&gt;</font>
00022 <font class="preprocessor">#endif</font>
00023 
00024 <font class="preprocessor">#ifdef HAVE_SYS_TIME_H</font>
00025 <font class="preprocessor">#include &lt;sys/time.h&gt;</font>
00026 <font class="preprocessor">#endif</font>
00027 
00028 <font class="preprocessor">#include &lt;ctype.h&gt;</font>
00029 <font class="preprocessor">#if HAVE_UTSNAME_H</font>
00030 <font class="preprocessor">#include &lt;utsname.h&gt;</font>
00031 <font class="preprocessor">#else</font>
00032 <font class="preprocessor">#if HAVE_SYS_UTSNAME_H</font>
00033 <font class="preprocessor">#include &lt;sys/utsname.h&gt;</font>
00034 <font class="preprocessor">#endif</font>
00035 <font class="preprocessor">#endif</font>
00036 <font class="preprocessor">#if HAVE_NETINET_IN_H</font>
00037 <font class="preprocessor">#include &lt;netinet/in.h&gt;</font>
00038 <font class="preprocessor">#endif</font>
00039 
00040 <font class="preprocessor">#if HAVE_DMALLOC_H</font>
00041 <font class="preprocessor">#include &lt;dmalloc.h&gt;</font>
00042 <font class="preprocessor">#endif</font>
00043 
00044 <font class="preprocessor">#include &lt;net-snmp/net-snmp-includes.h&gt;</font>
00045 <font class="preprocessor">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</font>
00046 
00047 <font class="preprocessor">#include "system_mib.h"</font>
00048 
00049 
00050         <font class="comment">/*********************</font>
00051          *
00052          *  Kernel &amp; interface information,
00053          *   and internal forward declarations
00054          *
00055          *********************/
00056 
00057 <font class="preprocessor">#define SYS_STRING_LEN  256</font>
00058 <font class="keywordtype">char</font> version_descr[ SYS_STRING_LEN ] = VERS_DESC;
00059 <font class="keywordtype">char</font> sysContact[    SYS_STRING_LEN ] = SYS_CONTACT;
00060 <font class="keywordtype">char</font> sysName[       SYS_STRING_LEN ] = SYS_NAME;
00061 <font class="keywordtype">char</font> sysLocation[   SYS_STRING_LEN ] = SYS_LOC;
00062 oid version_sysoid[]                 = { SYSTEM_MIB };
00063 <font class="keywordtype">int</font> version_sysoid_len               = OID_LENGTH( version_sysoid );
00064 
00065 <font class="keywordtype">char</font> oldversion_descr[ SYS_STRING_LEN ];
00066 <font class="keywordtype">char</font> oldsysContact[    SYS_STRING_LEN ];
00067 <font class="keywordtype">char</font> oldsysName[       SYS_STRING_LEN ];
00068 <font class="keywordtype">char</font> oldsysLocation[   SYS_STRING_LEN ];
00069 
00070 <font class="keywordtype">int</font> sysServices=72;
00071 <font class="keywordtype">int</font> sysServicesConfiged=0;
00072 
00073 <font class="keyword">extern</font> oid version_id[];
00074 <font class="keyword">extern</font> <font class="keywordtype">int</font> version_id_len;
00075 
00076 <font class="keyword">static</font> <font class="keywordtype">int</font> sysContactSet = 0, sysLocationSet = 0, sysNameSet = 0;
00077 
00078 WriteMethod writeSystem;
00079 <font class="keywordtype">int</font> header_system(<font class="keyword">struct</font> variable *,oid *, size_t *, <font class="keywordtype">int</font>, size_t *, WriteMethod **);
00080 
00081         <font class="comment">/*********************</font>
00082          *
00083          *  snmpd.conf config parsing
00084          *
00085          *********************/
00086 
00087 <font class="keywordtype">void</font> system_parse_config_sysloc(<font class="keyword">const</font> <font class="keywordtype">char</font> *token, <font class="keywordtype">char</font> *cptr)<font class="keyword"></font>
00088 {
00089   <font class="keywordtype">char</font> tmpbuf[1024];
00090 
00091   <font class="keywordflow">if</font> (strlen(cptr) &gt;= <font class="keyword">sizeof</font>(sysLocation))<font class="keyword"> </font>{
00092       snprintf(tmpbuf, 1024,<font class="stringliteral">"syslocation token too long (must be &lt; %d):\n\t%s"</font>,
00093                <font class="keyword">sizeof</font>(sysLocation), cptr);
00094       config_perror(tmpbuf);
00095   }
00096 
00097   <font class="keywordflow">if</font> (strcmp(token, <font class="stringliteral">"psyslocation"</font>) == 0)<font class="keyword"> </font>{
00098       <font class="keywordflow">if</font> (sysLocationSet &lt; 0) {
00099           <font class="comment">/*  This is bogus (and shouldn't happen anyway) -- the sysLocation</font>
00100               is already configured read-only.  */
00101           snmp_log(LOG_WARNING,
00102                    <font class="stringliteral">"ignoring attempted override of read-only sysLocation.0\n"</font>);
00103           <font class="keywordflow">return</font>;
00104       } <font class="keywordflow">else</font> {
00105           sysLocationSet++;
00106       }
00107   } <font class="keywordflow">else</font> {
00108       <font class="keywordflow">if</font> (sysLocationSet &gt; 0) {
00109           <font class="comment">/*  This is bogus (and shouldn't happen anyway) -- we already read a</font>
00110               persistent value of sysLocation, which we should ignore in
00111               favour of this one.  */
00112           snmp_log(LOG_WARNING,
00113                    <font class="stringliteral">"ignoring attempted override of read-only sysLocation.0\n"</font>);
00114           <font class="comment">/*  Fall through and copy in this value.  */</font>
00115       }      
00116       sysLocationSet = -1;
00117   }
00118   
00119   <font class="keywordflow">if</font> (strcmp(cptr,<font class="stringliteral">"\"\""</font>) == 0)<font class="keyword"> </font>{
00120       sysLocation[0] = <font class="charliteral">'\0'</font>;
00121   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strlen(cptr) &lt; <font class="keyword">sizeof</font>(sysLocation))<font class="keyword"> </font>{
00122       strcpy(sysLocation,cptr);
00123   } 
00124 }
00125 
00126 <font class="keywordtype">void</font> system_parse_config_syscon(<font class="keyword">const</font> <font class="keywordtype">char</font> *token, <font class="keywordtype">char</font> *cptr)<font class="keyword"></font>
00127 {
00128   <font class="keywordtype">char</font> tmpbuf[1024];
00129 
00130   <font class="keywordflow">if</font> (strlen(cptr) &gt;= <font class="keyword">sizeof</font>(sysContact))<font class="keyword"> </font>{
00131       snprintf(tmpbuf, 1024,<font class="stringliteral">"syscontact token too long (must be &lt; %d):\n\t%s"</font>,
00132                <font class="keyword">sizeof</font>(sysContact), cptr);
00133       config_perror(tmpbuf);
00134   }
00135 
00136   <font class="keywordflow">if</font> (strcmp(token, <font class="stringliteral">"psyscontact"</font>) == 0)<font class="keyword"> </font>{
00137       <font class="keywordflow">if</font> (sysContactSet &lt; 0) {
00138           <font class="comment">/*  This is bogus (and shouldn't happen anyway) -- the sysContact</font>
00139               is already configured read-only.  */
00140           snmp_log(LOG_WARNING,
00141                    <font class="stringliteral">"ignoring attempted override of read-only sysContact.0\n"</font>);
00142           <font class="keywordflow">return</font>;
00143       } <font class="keywordflow">else</font> {
00144           sysContactSet++;
00145       }
00146   } <font class="keywordflow">else</font> {
00147       <font class="keywordflow">if</font> (sysContactSet &gt; 0) {
00148           <font class="comment">/*  This is bogus (and shouldn't happen anyway) -- we already read a</font>
00149               persistent value of sysContact, which we should ignore in favour
00150               of this one.  */
00151           snmp_log(LOG_WARNING,
00152                    <font class="stringliteral">"ignoring attempted override of read-only sysContact.0\n"</font>);
00153           <font class="comment">/*  Fall through and copy in this value.  */</font>
00154       }
00155       sysContactSet = -1;
00156   }
00157   
00158   <font class="keywordflow">if</font> (strcmp(cptr,<font class="stringliteral">"\"\""</font>) == 0)<font class="keyword"> </font>{
00159       sysContact[0] = <font class="charliteral">'\0'</font>;
00160   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strlen(cptr) &lt; <font class="keyword">sizeof</font>(sysContact))<font class="keyword"> </font>{
00161       strcpy(sysContact,cptr);
00162   } 
00163 }
00164 
00165 <font class="keywordtype">void</font> system_parse_config_sysname(<font class="keyword">const</font> <font class="keywordtype">char</font> *token, <font class="keywordtype">char</font> *cptr)<font class="keyword"></font>
00166 {
00167   <font class="keywordtype">char</font> tmpbuf[1024];
00168 
00169   <font class="keywordflow">if</font> (strlen(cptr) &gt;= <font class="keyword">sizeof</font>(sysName))<font class="keyword"> </font>{
00170       snprintf(tmpbuf, 1024,<font class="stringliteral">"sysname token too long (must be &lt; %d):\n\t%s"</font>,
00171                <font class="keyword">sizeof</font>(sysName), cptr);
00172       config_perror(tmpbuf);
00173   }
00174 
00175   <font class="keywordflow">if</font> (strcmp(token, <font class="stringliteral">"psysname"</font>) == 0)<font class="keyword"> </font>{
00176       <font class="keywordflow">if</font> (sysNameSet &lt; 0) {
00177           <font class="comment">/*  This is bogus (and shouldn't happen anyway) -- the sysName</font>
00178               is already configured read-only.  */
00179           snmp_log(LOG_WARNING,
00180                    <font class="stringliteral">"ignoring attempted override of read-only sysName.0\n"</font>);
00181           <font class="keywordflow">return</font>;
00182       } <font class="keywordflow">else</font> {
00183           sysNameSet++;
00184       }
00185   } <font class="keywordflow">else</font> {
00186        <font class="keywordflow">if</font> (sysNameSet &gt; 0) {
00187           <font class="comment">/*  This is bogus (and shouldn't happen anyway) -- we already read a</font>
00188               persistent value of sysName, which we should ignore in favour
00189               of this one.  */
00190           snmp_log(LOG_WARNING,
00191                    <font class="stringliteral">"ignoring attempted override of read-only sysName.0\n"</font>);
00192           <font class="comment">/*  Fall through and copy in this value.  */</font>
00193       }     
00194       sysNameSet = -1;
00195   }
00196   
00197   <font class="keywordflow">if</font> (strcmp(cptr,<font class="stringliteral">"\"\""</font>) == 0)<font class="keyword"> </font>{
00198       sysName[0] = <font class="charliteral">'\0'</font>;
00199   } <font class="keywordflow">else</font> <font class="keywordflow">if</font> (strlen(cptr) &lt; <font class="keyword">sizeof</font>(sysName))<font class="keyword"> </font>{
00200       strcpy(sysName,cptr);
00201   } 
00202 }
00203 
00204 <font class="keywordtype">void</font> system_parse_config_sysServices(<font class="keyword">const</font> <font class="keywordtype">char</font> *token, <font class="keywordtype">char</font> *cptr)<font class="keyword"></font>
00205 {
00206   sysServices = atoi(cptr);
00207   sysServicesConfiged = 1;
00208 }
00209 
00210 
00211         <font class="comment">/*********************</font>
00212          *
00213          *  Initialisation &amp; common implementation functions
00214          *
00215          *********************/
00216 
00217 <font class="comment">/* define the structure we're going to ask the agent to register our</font>
00218    information at */
00219 <font class="keyword">struct </font>variable2 system_variables[] = {
00220     {VERSION_DESCR, ASN_OCTET_STR, RONLY, var_system, 1, {1}},
00221     {VERSIONID, ASN_OBJECT_ID, RONLY, var_system, 1, {2}},
00222     {UPTIME, ASN_TIMETICKS, RONLY, var_system, 1, {3}},
00223     {SYSCONTACT, ASN_OCTET_STR, RWRITE, var_system, 1, {4}},
00224     {SYSTEMNAME, ASN_OCTET_STR, RWRITE, var_system, 1, {5}},
00225     {SYSLOCATION, ASN_OCTET_STR, RWRITE, var_system, 1, {6}},
00226     {SYSSERVICES, ASN_INTEGER, RONLY, var_system, 1, {7}},
00227     {SYSORLASTCHANGE, ASN_TIMETICKS, RONLY, var_system, 1, {8}}
00228 };
00229 <font class="comment">/* Define the OID pointer to the top of the mib tree that we're</font>
00230    registering underneath */
00231 oid system_variables_oid[] = { SNMP_OID_MIB2,1 };
00232 oid system_module_oid[]    = { SNMP_OID_SNMPMODULES,1 };
00233 <font class="keywordtype">int</font> system_module_oid_len  = <font class="keyword">sizeof</font>( system_module_oid ) / <font class="keyword">sizeof</font>( oid );
00234 <font class="keywordtype">int</font> system_module_count    = 0;
00235 
00236 <font class="keyword">static</font> <font class="keywordtype">int</font>
00237 system_store(<font class="keywordtype">int</font> a, <font class="keywordtype">int</font> b, <font class="keywordtype">void</font> *c, <font class="keywordtype">void</font> *d)<font class="keyword"></font>
00238 {
00239   <font class="keywordtype">char</font> line[SNMP_MAXBUF_SMALL];
00240 
00241   <font class="keywordflow">if</font> (sysLocationSet &gt; 0) {
00242       snprintf(line, SNMP_MAXBUF_SMALL, <font class="stringliteral">"psyslocation %s"</font>, sysLocation);
00243       snmpd_store_config(line);
00244   }
00245   <font class="keywordflow">if</font> (sysContactSet &gt; 0) {
00246       snprintf(line, SNMP_MAXBUF_SMALL, <font class="stringliteral">"psyscontact %s"</font>, sysContact);
00247       snmpd_store_config(line);
00248   }
00249   <font class="keywordflow">if</font> (sysNameSet &gt; 0) {
00250       snprintf(line, SNMP_MAXBUF_SMALL, <font class="stringliteral">"psysname %s"</font>, sysName);
00251       snmpd_store_config(line);
00252   }
00253 
00254   <font class="keywordflow">return</font> 0;
00255 }
00256 
00257 <font class="keywordtype">void</font> init_system_mib(<font class="keywordtype">void</font>)<font class="keyword"></font>
00258 {
00259 
00260 <font class="preprocessor">#ifdef HAVE_UNAME</font>
00261   <font class="keyword">struct </font>utsname utsName;
00262 
00263   uname(&amp;utsName);
00264   sprintf(version_descr, <font class="stringliteral">"%s %s %s %s %s"</font>, utsName.sysname, utsName.nodename,
00265           utsName.release, utsName.version, utsName.machine);
00266 <font class="preprocessor">#else</font>
00267 <font class="preprocessor">#if HAVE_EXECV</font>
00268   <font class="keyword">struct </font>extensible extmp;
00269 
00270   <font class="comment">/* set default values of system stuff */</font>
00271   sprintf(extmp.command,<font class="stringliteral">"%s -a"</font>,UNAMEPROG);
00272   <font class="comment">/* setup defaults */</font>
00273   extmp.type = EXECPROC;
00274   extmp.next = NULL;
00275   exec_command(&amp;extmp);
00276   strncpy(version_descr,extmp.output, <font class="keyword">sizeof</font>(version_descr));
00277   version_descr[strlen(version_descr)-1] = 0; <font class="comment">/* chomp new line */</font>
00278 #<font class="keywordflow">else</font>
00279   strcpy(version_descr, <font class="stringliteral">"unknown"</font> );
00280 <font class="preprocessor">#endif</font>
00281 <font class="preprocessor">#endif</font>
00282 
00283 <font class="preprocessor">#ifdef HAVE_GETHOSTNAME</font>
00284   gethostname(sysName,<font class="keyword">sizeof</font>(sysName));
00285 <font class="preprocessor">#else</font>
00286 <font class="preprocessor">#ifdef HAVE_UNAME</font>
00287   strncpy(sysName,utsName.nodename,<font class="keyword">sizeof</font>(sysName));
00288 <font class="preprocessor">#else</font>
00289 <font class="preprocessor">#if HAVE_EXECV</font>
00290   sprintf(extmp.command,<font class="stringliteral">"%s -n"</font>,UNAMEPROG);
00291   <font class="comment">/* setup defaults */</font>
00292   extmp.type = EXECPROC;
00293   extmp.next = NULL;
00294   exec_command(&amp;extmp);
00295   strncpy(sysName,extmp.output, <font class="keyword">sizeof</font>(sysName));
00296   sysName[strlen(sysName)-1] = 0; <font class="comment">/* chomp new line */</font>
00297 #<font class="keywordflow">else</font>
00298   strcpy(sysName, <font class="stringliteral">"unknown"</font> );
00299 <font class="preprocessor">#endif </font><font class="comment">/* HAVE_EXECV */</font>
00300 <font class="preprocessor">#endif </font><font class="comment">/* HAVE_UNAME */</font>
00301 <font class="preprocessor">#endif </font><font class="comment">/* HAVE_GETHOSTNAME */</font>
00302 
00303   <font class="comment">/* register ourselves with the agent to handle our mib tree */</font>
00304   REGISTER_MIB(<font class="stringliteral">"mibII/system"</font>, system_variables, variable2,
00305                system_variables_oid);
00306 
00307   
00308   sysContactSet = sysLocationSet = sysNameSet = 0;
00309 
00310   <font class="comment">/* register our config handlers */</font>
00311   snmpd_register_config_handler(<font class="stringliteral">"syslocation"</font>, system_parse_config_sysloc,
00312                                 NULL, <font class="stringliteral">"location"</font>);
00313   snmpd_register_config_handler(<font class="stringliteral">"syscontact"</font>, system_parse_config_syscon,
00314                                 NULL,<font class="stringliteral">"contact-name"</font>);
00315   snmpd_register_config_handler(<font class="stringliteral">"sysname"</font>, system_parse_config_sysname,
00316                                 NULL,<font class="stringliteral">"node-name"</font>);
00317   snmpd_register_config_handler(<font class="stringliteral">"psyslocation"</font>, system_parse_config_sysloc,
00318                                 NULL, NULL);
00319   snmpd_register_config_handler(<font class="stringliteral">"psyscontact"</font>, system_parse_config_syscon,
00320                                 NULL, NULL);
00321   snmpd_register_config_handler(<font class="stringliteral">"psysname"</font>, system_parse_config_sysname,
00322                                 NULL, NULL);
00323   snmpd_register_config_handler(<font class="stringliteral">"sysservices"</font>, system_parse_config_sysServices,
00324                                 NULL,<font class="stringliteral">"NUMBER"</font>);
00325   snmp_register_callback(SNMP_CALLBACK_LIBRARY, SNMP_CALLBACK_STORE_DATA,
00326                          system_store, NULL);
00327 
00328 }
00329 
00330 
00331         <font class="comment">/*********************</font>
00332          *
00333          *  System specific implementation functions
00334          *
00335          *********************/
00336 
00337 <font class="preprocessor">#ifdef USING_MIBII_SYSORTABLE_MODULE</font>
00338 <font class="keyword">extern</font> <font class="keyword">struct </font>timeval sysOR_lastchange;
00339 <font class="preprocessor">#endif</font>
00340 
00341 u_char  *
00342 var_system(<font class="keyword">struct</font> variable *vp,
00343            oid *name,
00344            size_t *length,
00345            <font class="keywordtype">int</font> exact,
00346            size_t *var_len,
00347            WriteMethod **write_method)<font class="keyword"></font>
00348 {
00349 
00350     <font class="keywordflow">if</font> (header_generic(vp, name, length, exact, var_len, write_method) == MATCH_FAILED )
00351         <font class="keywordflow">return</font> NULL;
00352 
00353     <font class="keywordflow">switch</font> (vp-&gt;magic){
00354         <font class="keywordflow">case</font> VERSION_DESCR:
00355             *var_len = strlen(version_descr);
00356             *write_method = writeSystem;
00357             <font class="keywordflow">return</font> (u_char *)version_descr;
00358         <font class="keywordflow">case</font> VERSIONID:
00359             *var_len = version_sysoid_len*<font class="keyword">sizeof</font>(version_sysoid[0]);
00360             <font class="keywordflow">return</font> (u_char *)version_sysoid;
00361         <font class="keywordflow">case</font> UPTIME:
00362             long_return = get_agent_uptime();
00363             <font class="keywordflow">return</font> ((u_char *) &amp;long_return);
00364         <font class="keywordflow">case</font> SYSCONTACT:
00365             *var_len = strlen(sysContact);
00366             *write_method = writeSystem;
00367             <font class="keywordflow">return</font> (u_char *)sysContact;
00368         <font class="keywordflow">case</font> SYSTEMNAME:
00369             *var_len = strlen(sysName);
00370             *write_method = writeSystem;
00371             <font class="keywordflow">return</font> (u_char *)sysName;
00372         <font class="keywordflow">case</font> SYSLOCATION:
00373             *var_len = strlen(sysLocation);
00374             *write_method = writeSystem;
00375             <font class="keywordflow">return</font> (u_char *)sysLocation;
00376         <font class="keywordflow">case</font> SYSSERVICES:
00377 <font class="preprocessor">#if NO_DUMMY_VALUES</font>
00378             <font class="keywordflow">if</font> (!sysServicesConfiged)
00379                 <font class="keywordflow">return</font> NULL;
00380 <font class="preprocessor">#endif</font>
00381             long_return = sysServices;
00382             <font class="keywordflow">return</font> (u_char *)&amp;long_return;
00383 
00384 <font class="preprocessor">#ifdef USING_MIBII_SYSORTABLE_MODULE</font>
00385         <font class="keywordflow">case</font> SYSORLASTCHANGE:
00386               long_return = timeval_uptime( &amp;sysOR_lastchange );
00387               <font class="keywordflow">return</font> ((u_char *) &amp;long_return);
00388 <font class="preprocessor">#endif</font>
00389               
00390         <font class="keywordflow">default</font>:
00391             DEBUGMSGTL((<font class="stringliteral">"snmpd"</font>, <font class="stringliteral">"unknown sub-id %d in var_system\n"</font>, vp-&gt;magic));
00392     }
00393     <font class="keywordflow">return</font> NULL;
00394 }
00395 
00396 
00397 
00398 <font class="keywordtype">int</font>
00399 writeSystem(<font class="keywordtype">int</font> action,      
00400             u_char *var_val,
00401             u_char var_val_type,
00402             size_t var_val_len,
00403             u_char *statP,
00404             oid *name,
00405             size_t name_len)<font class="keyword"></font>
00406 {
00407     u_char *cp;
00408     <font class="keywordtype">char</font> *buf = NULL, *oldbuf = NULL;
00409     <font class="keywordtype">int</font> count, *setvar = NULL;
00410 
00411     <font class="keywordflow">switch</font>((char)name[7]){
00412       <font class="keywordflow">case</font> VERSION_DESCR:
00413         buf    = version_descr;
00414         oldbuf = oldversion_descr;
00415         <font class="keywordflow">break</font>;
00416       <font class="keywordflow">case</font> SYSCONTACT:
00417         buf    = sysContact;
00418         oldbuf = oldsysContact;
00419         setvar = &amp;sysContactSet;
00420         <font class="keywordflow">break</font>;
00421       <font class="keywordflow">case</font> SYSTEMNAME:
00422         buf    = sysName;
00423         oldbuf = oldsysName;
00424         setvar = &amp;sysNameSet;
00425         <font class="keywordflow">break</font>;
00426       <font class="keywordflow">case</font> SYSLOCATION:
00427         buf    = sysLocation;
00428         oldbuf = oldsysLocation;
00429         setvar = &amp;sysLocationSet;
00430         <font class="keywordflow">break</font>;
00431       <font class="keywordflow">default</font>:
00432         <font class="keywordflow">return</font> SNMP_ERR_GENERR;         <font class="comment">/* ??? */</font>
00433     }
00434 
00435     <font class="keywordflow">switch</font> (action) {
00436         <font class="keywordflow">case</font> RESERVE1:          <font class="comment">/* Check values for acceptability */</font>
00437             <font class="keywordflow">if</font> (var_val_type != ASN_OCTET_STR){
00438                 snmp_log(LOG_ERR, <font class="stringliteral">"not string\n"</font>);
00439                 <font class="keywordflow">return</font> SNMP_ERR_WRONGTYPE;
00440             }
00441             <font class="keywordflow">if</font> (var_val_len &gt; <font class="keyword">sizeof</font>(version_descr)-1){
00442                 snmp_log(LOG_ERR, <font class="stringliteral">"bad length\n"</font>);
00443                 <font class="keywordflow">return</font> SNMP_ERR_WRONGLENGTH;
00444             }
00445             
00446             <font class="keywordflow">for</font>(cp = var_val, count = 0; count &lt; (int)var_val_len; count++, cp++){
00447                 <font class="keywordflow">if</font> (!isprint(*cp))<font class="keyword"></font>{
00448                     snmp_log(LOG_ERR, <font class="stringliteral">"not print %x\n"</font>, *cp);
00449                     <font class="keywordflow">return</font> SNMP_ERR_WRONGVALUE;
00450                 }
00451             }
00452             <font class="keywordflow">if</font> (setvar != NULL &amp;&amp; *setvar &lt; 0) {
00453                 <font class="comment">/*  The object is set in a read-only configuration file.  */</font>
00454                 <font class="keywordflow">return</font> SNMP_ERR_NOTWRITABLE;
00455             }
00456             <font class="keywordflow">break</font>;
00457 
00458         <font class="keywordflow">case</font> RESERVE2:          <font class="comment">/* Allocate memory and similar resources */</font>
00459 
00460                 <font class="comment">/* Using static strings, so nothing needs to be done */</font>
00461             <font class="keywordflow">break</font>;
00462 
00463         <font class="keywordflow">case</font> ACTION:            <font class="comment">/* Perform the SET action (if reversible) */</font>
00464 
00465                 <font class="comment">/* Save the old value, in case of UNDO */</font>
00466             strcpy( oldbuf, buf);
00467             memcpy( buf, var_val, var_val_len);
00468             buf[var_val_len] = 0;
00469             <font class="keywordflow">break</font>;
00470 
00471         <font class="keywordflow">case</font> UNDO:              <font class="comment">/* Reverse the SET action and free resources */</font>
00472 
00473             strcpy( buf, oldbuf);
00474             oldbuf[0] = 0;
00475             <font class="keywordflow">break</font>;
00476 
00477         <font class="keywordflow">case</font> COMMIT:
00478             <font class="keywordflow">if</font> (setvar != NULL) {
00479                 *setvar = 1;
00480             }
00481             snmp_save_persistent(ds_get_string(DS_LIBRARY_ID, DS_LIB_APPTYPE));
00482             (void)snmp_call_callbacks(SNMP_CALLBACK_LIBRARY,
00483                                       SNMP_CALLBACK_STORE_DATA, NULL);
00484             snmp_clean_persistent(ds_get_string(DS_LIBRARY_ID,DS_LIB_APPTYPE));
00485 
00486         <font class="keywordflow">case</font> FREE:              <font class="comment">/* Free any resources allocated */</font>
00487 
00488                 <font class="comment">/* No resources have been allocated, but "empty" the 'oldbuf' */</font>
00489             oldbuf[0] = 0;
00490             <font class="keywordflow">break</font>;
00491     }
00492     <font class="keywordflow">return</font> SNMP_ERR_NOERROR;
00493 } <font class="comment">/* end of writeSystem */</font>
00494 
00495         <font class="comment">/*********************</font>
00496          *
00497          *  Internal implementation functions - None
00498          *
00499          *********************/
00500 
<!--#include virtual="/sfbutton.html" -->
</pre></div><hr><address><small><!--#include virtual="/sfbutton.html" -->
 Wed Mar 6 16:57:10 2002 for net-snmp by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.11 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
<!--#include virtual="/sfbutton.html" -->
<!-- CONTENT END -->
<!--#include virtual="/page-bottom.html" -->

